# Deep Learning for Network Flow Analysis and Malware Classification
## 问题：
DL应用于1网络协议分类、2网络应用分类、3恶意代码分类。
NTA网络流量分析：流特征和数据签名。

## 引入：
（1）	当前大部分协议分类方法基于参数：端口号、静态headers、IP地址等。

（2）	传统的利用原始流量信息进行网络应用分类的方法：利用有限行为特征定义启发式特征。包括端口号，传输速率和频率？、应用和协议header信息。现在面临问题：隧道，随机端口，代理，加密。

（3）	传统恶意代码分类方法：利用启发式的行为签名。签名利用算法或哈希生成，表征一种特定的病毒。同家族的病毒的行为相同，将生成相同签名。问题：病毒作者通过多态和变态方式干扰防病毒软件，改变已知签名。->解决：为网络应用、协议、恶意代码生成数据签名。

Kaggle2015恶意代码数据集：16进制恶意代码可执行机器码。ID：20字符的哈希值，label。Byte count，Address，Record type，数据和校验和。

DL方法汇总：监督学习：逻辑回归，MLP多层感知机，CNN。
半监督/无监督：autoencoder，RBM，DBN。

## 方法：
网络应用分类/协议分类常基于统计特征+ML。人工手动特征。问题： 耗时、不灵活、不能检测未知应用/协议。

DL自动提取特征：将全部payload放入autoencoder。参考文献17。

Kaggle2015恶意代码分类特征提取三类重要方法：（1）opcode n-gram，n=2,3，4。（2）Segment line count。（3）asm文件（汇编文件）像素特征。

序列分类问题：基因分类（生物计算）。过于依赖手动特征。

一、	基于metadata的协议分类

采集工具：wireshark，Tshark。只取HTTP，SSL，SMTP协议的数据包。取payload的部分信息，避免计算量太大。（1024字节向量，转换为十进制数值。）

二、	网络应用分类的payload数据获取和数据预处理

用tcpdump捕包，提取payload信息。
三种网络应用：浏览器（2种），Facebook，Torrent。
数据集：3w+总数据包，上面3中每个1w左右。数据payload是16进制，转换为10进制数值。

三、	Kaggle数据集恶意代码分类

二进制文件内容，16进制表示。预处理为数值，128维向量，逗号分隔。

模型：2层CNN+max pooling+2个全连接层？。
 
Tf开发。Dropout防止过拟合。
3类问题输入都是固定维度。具体预处理没说。

四、	autoencoder做特征提取

1024输入->隐层512节点->输出层
用输入输出均方误差做error训练，用batched stochastic gradient decent训。隐层做特征。训练计算量大，但是是一次性工作。

## 实验：
（1）	协议分类：7w+数据包，5w训练2w测试。CNN 2000轮迭代准确率83%+。Autoencoder+softmax分类 1700迭代 75%+准确率。

（2）	3类网络应用分类：上述CNN结构。调参：先调学习率，定为0.0001，再调dropout，定为0.9，再调epochs。最终2000 epochs，3类应用平均准确率97%+。Torrent准确率相比来说最低，因为torrent传输使用隧道和加密技术。用更多数据训练可提升准确性。
先autoencoder提特征再上述CNN结构：3类应用平均准确率99%+。

（3）	kaggle恶意代码分类：上述CNN结构，准确率94%+。

## 结论：
DL提取的抽象特征比人类直接肉眼提取的特征（比如基础统计行为、端口号、header信息、格式等），信息量更大。并且这些抽象特征attacker也不可见，所以数据指纹不可被操作。

## 展望工作：
（1）用RNN/LSTM，数据可能有关联和序列行为。在小型网络中捕包做实验，再扩张到更大的网络。

（2）扩展应用类型，尤其增加私有协议。
可以在Botnets（僵尸网络）上做分类，实时监测感染？

（3）怀疑是恶意的代码可以被过滤或至少在真正执行之前被隔离。

（4）以同样的方式，可以在桥接器和路由器上设置网络流量过滤器，这些网络流量过滤器可以基于学习模型进行恶意或拥塞训练，从而使流量进行选择性减载。







